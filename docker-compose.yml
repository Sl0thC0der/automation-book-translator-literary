services:
  translator:
    build:
      context: .
      target: translator
    container_name: book-translator-3pass
    init: true
    environment:
      - BBM_CLAUDE_API_KEY=${ANTHROPIC_API_KEY}
    volumes:
      - ./books:/books
      - ./output:/output
      - ./examples/profiles:/app/profiles:ro
    entrypoint: ["python3", "make_book.py"]
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  orchestrator:
    build:
      context: .
      target: orchestrator
    container_name: book-orchestrator-3pass
    init: true
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - BBM_CLAUDE_API_KEY=${ANTHROPIC_API_KEY}
    volumes:
      - ./books:/books
      - ./output:/output
      - ./reports:/reports
      - ./examples/profiles:/app/profiles:ro
    entrypoint: ["python3", "run_orchestrator.py"]
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

# --- Usage -----------------------------------------------------------------------
#
# Setup:
#   mkdir -p books output reports
#   cp your_book.epub books/input.epub
#   export ANTHROPIC_API_KEY=sk-ant-XXXXX
#
# --- Translator Examples ---------------------------------------------------------
#
# 1. Test on 5 paragraphs first (always do this!):
#    docker compose run --rm translator \
#      --book_name /books/input.epub \
#      -m 3pass-sonnet \
#      --single_translate --language de --use_context \
#      --test --test_num 5
#
# 2. Generic EN→DE (no profile, default literary style):
#    docker compose run --rm translator \
#      --book_name /books/input.epub \
#      -m 3pass-sonnet \
#      --single_translate --language de --use_context
#
# 3. EN→DE with Lovecraft profile (Opus for best quality):
#    docker compose run --rm translator \
#      --book_name /books/lovecraft.epub \
#      -m 3pass-opus \
#      --single_translate --language de --use_context \
#      --translation-profile /app/profiles/lovecraft.json
#
# 4. EN→FR sci-fi:
#    docker compose run --rm translator \
#      --book_name /books/scifi_novel.epub \
#      -m 3pass-sonnet \
#      --single_translate --language fr --use_context \
#      --translation-profile /app/profiles/scifi.json
#
# 5. Budget mode — skip review (pass 1 only, ~40% cheaper):
#    docker compose run --rm translator \
#      --book_name /books/input.epub \
#      -m 3pass-sonnet \
#      --single_translate --language de --use_context \
#      --skip-review
#
# 6. Resume after interruption:
#    docker compose run --rm translator \
#      --book_name /books/input.epub \
#      -m 3pass-opus \
#      --single_translate --language de --use_context \
#      --resume
#
# --- Orchestrator Examples -------------------------------------------------------
#
# 7. Orchestrated translation (full automated pipeline):
#    docker compose run --rm orchestrator \
#      /books/input.epub -l de -m 3pass-sonnet \
#      --profiles-dir /app/profiles --report-dir /reports
#
# 8. Orchestrator test run (10 paragraphs):
#    docker compose run --rm orchestrator \
#      /books/input.epub -l de -m 3pass-sonnet \
#      --profiles-dir /app/profiles --report-dir /reports \
#      --test-num 10
#
# Output:
#   Translated .epub appears in ./output/ (or same directory as input)
#   Orchestrator reports appear in ./reports/
